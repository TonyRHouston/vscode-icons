name: SVG Icon Check
on:
  workflow_dispatch: {}
permissions:
  contents: read
  pull-requests: write
jobs:
  test_icon:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Fork
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.ref }}
        repository: ${{ github.event.pull_request.head.repo.full_name }}
        path: fork
        sparse-checkout-cone-mode: false
        sparse-checkout: icons/
    - name: Checkout Base
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        path: base
        sparse-checkout-cone-mode: false
        sparse-checkout: icons/
    - name: Ensure Base is Up-to-Date
      working-directory: base
      run: 'git fetch origin ${{ github.event.pull_request.base.ref }}

        git reset --hard origin/${{ github.event.pull_request.base.ref }}

        '
    - name: Find modified SVGs
      id: changed-svgs
      working-directory: base
      run: "# Ensure directories exist\nif [ ! -d \"../base\" ] || [ ! -d \"../fork\"\
        \ ]; then\n  echo \"Error: One or both directories do not exist.\"\n  exit\
        \ 1\nfi\n\n# Check raw output from git diff\nFILES=$(git diff --no-index ../base\
        \ ../fork --diff-filter=ACMRTUX --name-only | grep -v '^../fork/.git/' ||\
        \ true)\necho \"Raw git diff output:\"\necho \"$FILES\"\n\n# Ensure git diff\
        \ is not empty\nif [ -z \"$FILES\" ]; then\n  echo \"No differences found.\
        \ Exiting.\"\n  echo \"SVG_CHANGED=false\" >> $GITHUB_OUTPUT\n  exit 0\nfi\n\
        \n# Filter only SVG files\nFILTERED_FILES=$(echo \"$FILES\" | grep '^\\.\\\
        ./fork/icons/.*\\.svg$' || true)\necho \"Filtered files:\"\necho \"$FILTERED_FILES\"\
        \n\n# Ensure we count only non-empty lines\nfilesCount=$(echo \"$FILTERED_FILES\"\
        \ | grep -c . || true)\necho \"filesCount=$filesCount\"\n\n# Get file sizes\n\
        SIZES=\"\"\nfor file in $FILTERED_FILES; do\n  size=$(stat --format=\"%s\"\
        \ \"$file\")  # Linux: stat --format=\"%s\", macOS: stat -f%z\n  SIZES+=\"\
        $size \"\ndone\n\n# If files were found, set the output\nif [ \"$filesCount\"\
        \ -gt 0 ]; then \n  echo \"SVG_CHANGED=true\" >> $GITHUB_OUTPUT\n  echo \"\
        files=$(echo \"$FILTERED_FILES\" | tr '\\n' ' ')\" >> $GITHUB_OUTPUT\n  echo\
        \ \"files=$FILTERED_FILES\"\n  echo \"sizes=$(echo \"$SIZES\" | tr '\\n' '\
        \ ')\" >> $GITHUB_OUTPUT \n  echo \"sizes=$SIZES\"\nelse\n  echo \"SVG_CHANGED=false\"\
        \ >> $GITHUB_OUTPUT\nfi\n"
    - name: Download CLI Tool
      if: steps.changed-svgs.outputs.SVG_CHANGED == 'true'
      working-directory: base
      run: 'LATEST_URL="https://github.com/robertohuertasm/svg-icon-check/releases/latest/download/svg-icon-check"

        curl -L $LATEST_URL -o svg-icon-check

        chmod +x svg-icon-check

        '
    - name: Generate Preview Images
      if: steps.changed-svgs.outputs.SVG_CHANGED == 'true'
      working-directory: base
      run: "mkdir -p previews\nfor svg_file in ${{ steps.changed-svgs.outputs.files\
        \ }}; do\n  echo \"Processing: $svg_file\"\n  ./svg-icon-check \"$svg_file\"\
        \ -b 30,30,30 40,42,54 46,52,64 47,54,59 39,40,34 60,63,65 88,110,117 89,91,79\
        \ 120,120,120 253,246,227 236,239,244 242,242,242 250,250,250 -o \"previews/$(basename\
        \ \"$svg_file\" .svg)-preview.png\"\ndone\n"
    - name: Upload to Permanent Hosting and Generate Comment
      if: steps.changed-svgs.outputs.SVG_CHANGED == 'true'
      id: generate-comment
      working-directory: base
      env:
        IMAGE_UPLOAD: ${{ secrets.IMAGES_API_KEY }}
      run: "# Install jq for JSON parsing\nsudo apt-get install -y jq\nCOMMENT_BODY=\"\
        ## Icons Background Test\\n\\n\"\n\nfile_list=(${{ steps.changed-svgs.outputs.files\
        \ }})\nsize_list=(${{ steps.changed-svgs.outputs.sizes }})\n\nfor index in\
        \ \"${!file_list[@]}\"; do\n  filename=$(basename \"${file_list[$index]}\"\
        \ .svg)\n  size=\"${size_list[$index]}\"\n  png_file=\"previews/${filename}-preview.png\"\
        \n  \n  # Upload to image host\n  response=$(curl -s --location 'https://freeimage.host/json'\
        \ \\\n    --form \"source=@$png_file\" \\\n    --form \"type=file\" \\\n \
        \   --form \"action=upload\" \\\n    --form \"auth_token=$IMAGE_UPLOAD\")\n\
        \  \n  image_url=$(echo \"$response\" | jq -r '.image.url')\n  echo \"Uploaded:\
        \ $image_url\"\n  \n  # Build comment body\n  COMMENT_BODY+=\"#### ${filename}\
        \ (${size} bytes)\\n\"\n  COMMENT_BODY+=\"![Preview]($image_url)\\n\\n\"\n\
        done\n\n# Set output for next step\necho \"comment_body<<EOF\" >> $GITHUB_OUTPUT\n\
        echo -e \"$COMMENT_BODY\" >> $GITHUB_OUTPUT\necho \"EOF\" >> $GITHUB_OUTPUT\n"
    - name: Find comment ID if it exists
      if: steps.changed-svgs.outputs.SVG_CHANGED == 'true'
      uses: peter-evans/find-comment@v3
      id: find-comment
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ github.event.pull_request.number }}
        comment-author: github-actions[bot]
        body-includes: <!-- svg-preview-comment -->
    - name: Post/Update Comment
      if: steps.changed-svgs.outputs.SVG_CHANGED == 'true'
      uses: peter-evans/create-or-update-comment@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ github.event.pull_request.number }}
        comment-id: ${{ steps.find-comment.outputs.comment-id }}
        body: '${{ steps.generate-comment.outputs.comment_body }}

          <!-- svg-preview-comment -->

          '
        edit-mode: replace
